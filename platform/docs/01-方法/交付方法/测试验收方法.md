# 测试验收方法

> 状态: **已验证** | 版本: v0.3.0 | 创建: 2026-02-16 | 上次验证: 2026-02-17（ERP 项目 Phase 3 试跑）

## 定位

指导如何执行端到端集成测试、UAT 验收测试、性能测试和安全审计。对应 SDLC Phase 3 的第一大活动，是上线前的最后质量关卡。

适用于 Odoo 17 Community 项目，1 人 + AI 开发模式下的精简测试策略。

对应质量框架五层防线中的 L3（自动化测试）和 L4（UAT 验收）。

## 前置条件

- Phase 2 退出条件全部满足（所有模块开发完成、测试覆盖率 ≥ 80%）
- 测试环境（staging）准备就绪（生产镜像配置，独立数据库）
- BDD 行为规格可用（作为 UAT 测试用例来源）
- Phase 2 → Phase 3 门禁已通过

## 步骤

### Step 1: 端到端集成测试

**做什么**：验证跨模块的完整业务流程，确保所有模块联动正常。区别于 Phase 2 中的模块级单元测试，本步骤关注**端到端贯通**。

**AI 引导问题**：
1. 核心业务流程有哪几条？（至少覆盖：采购→入库→销售→出库→财务）
2. 每条流程涉及哪些模块？模块间的数据传递点在哪里？
3. 有没有跨模块的边界场景？（如：部分收货后的财务处理、退货后的库存回退）

**操作要点**：
- 在 staging 环境执行，使用接近真实的数据量（非空库）
- 使用 Odoo `TransactionCase`（单元/集成测试）或 `HttpCase`（浏览器级 E2E）编写测试脚本
- 每条流程从"创建单据"到"完成闭环"全程走通
- 测试数据准备：至少 3 个供应商、5 个客户、20 个产品、多币种场景
- 记录每个步骤的预期结果 vs 实际结果

> **Odoo 测试框架实操经验**（Phase 3 试跑总结）：
> - **`TransactionCase` vs `HttpCase`**：大部分 E2E 测试用 `TransactionCase` + ORM 模拟即可，`HttpCase` 仅用于真正需要浏览器交互的场景（如 JS Widget 测试）
> - **跨模块字段陷阱**：安装 `sale` 模块后，`product.template` 会新增 `sale_line_warn`（NOT NULL）字段。测试中创建产品时若未显式设置该字段，会触发 `NotNullViolation`。解决方法：在 `setUpClass` 中执行 `ALTER TABLE product_template ALTER COLUMN sale_line_warn SET DEFAULT 'no-message'`
> - **`@api.constrains` 触发条件**：装饰器只在列出的字段被 `create/write` 显式传递时触发。若需确保约束在 `create` 时始终生效，需把必传字段（如 `name`）加入装饰器参数
> - **`_approval_allowed` 覆盖**：自定义审批流时，标准 Odoo 的 `_approval_allowed` 可能允许 `purchase_manager` 自动审批，绕过自定义审批逻辑。需显式 override 返回 `False`
> - **安全组 `implied_ids`**：Odoo 的 `res.groups` 支持组继承，高级组自动包含低级组权限。测试 RBAC 时，不能假设"只有 A 组权限"——如果 B 组 implies A 组，B 组用户也能执行 A 级操作

**核心测试流程清单**：

| 编号 | 流程 | 涉及模块 | 关键检查点 |
|------|------|---------|-----------|
| E2E-01 | 采购→入库→付款 | purchase, stock, account | PO 金额→Receipt 数量→Bill 金额一致 |
| E2E-02 | 销售→出库→收款 | sale, stock, account | SO 数量→Delivery 数量→Invoice 金额一致 |
| E2E-03 | 采购→入库→销售→出库 | purchase, stock, sale | 库存数量全程正确 |
| E2E-04 | 多币种采购→汇率→付款 | purchase, account | 汇率换算正确、汇兑损益记录 |
| E2E-05 | 采购审批→多级审批→确认 | purchase, erp_purchase_approval | 审批流状态流转正确 |

**输出**：集成测试报告（填入模板 Part 1）

### Step 2: UAT 验收测试

**做什么**：业务方按 BDD 行为规格逐项操作确认，验证系统行为符合业务预期。UAT 的测试用例直接来源于 Phase 1 产出的 BDD 场景（Given/When/Then）。

**AI 引导问题**：
1. BDD 场景是否覆盖了所有核心业务规则？
2. 业务方是谁？能否安排独立操作测试？（1 人项目中可能是项目负责人自测）
3. 哪些场景必须业务方亲自确认？哪些可以 AI 代为验证？

**操作要点**：
- 将 BDD 场景转化为可操作的测试步骤清单（带截图指引）
- 每个场景标记：通过 / 失败 / 阻塞（附失败原因和截图）
- 失败项按缺陷分级（P0~P3）记录到 GitHub Issues
- P0/P1 缺陷必须修复后重测；P2 可带缺陷上线但需记录
- UAT 完成后需要业务方签字确认（或邮件确认）

> **1 人 + AI 项目的 UAT 模式**（试跑经验）：
> - 开发者本人按 BDD 场景逐步操作浏览器，AI 辅助验证结果截图
> - 严格按步骤走——避免"开发者直觉"跳过步骤（这是发现隐藏 Bug 的关键）
> - 可在浏览器中开启 Odoo 的 debug 模式（`?debug=1`），辅助确认状态值
> - 试跑中发现的问题：开发者倾向于"知道该怎么操作"而跳过非常规路径，建议强制执行"反向场景"（如：故意用无权限用户审批、超出金额限制的订单）

**UAT 判定标准**：

| 判定 | 条件 |
|------|------|
| **通过** | 所有 P0/P1 场景通过，P2 缺陷 ≤ 3 个 |
| **有条件通过** | P0 全部通过，P1 缺陷 ≤ 2 个且有绕过方案 |
| **不通过** | 存在未修复的 P0 缺陷，或 P1 缺陷 > 2 个 |

**输出**：UAT 测试报告 + 签字确认（填入模板 Part 2）

### Step 3: 性能测试

**做什么**：验证系统在生产级配置下的响应时间和并发能力，确保核心页面和操作满足性能基线。

**AI 引导问题**：
1. 核心页面有哪些？（采购订单列表、销售订单表单、库存看板、报表页面）
2. 预期的并发用户数是多少？（基于公司规模估算）
3. 数据量预期？（历史数据迁移后的记录数）

**操作要点**：
- 测试环境配置对齐生产：Odoo workers 数量、PostgreSQL 配置、Nginx 缓存
- 导入接近生产规模的数据量（如 1000+ 订单、5000+ 产品）
- 测量维度：页面加载时间、API 响应时间、数据库查询时间
- 工具：浏览器 DevTools Network 面板、`curl -w "%{time_total}\n" -o /dev/null -s [URL]`（API 响应计时）、Odoo `--log-level=debug_sql`、`pgbadger` 分析慢查询
- 发现慢查询时：检查索引、优化 ORM 查询、调整 workers/缓存

> **简易性能基线方法**（试跑经验）：对于 1 人项目，无需重量级压测工具。`curl` 计时 + 浏览器 Network 面板即可建立基线。试跑中测量了 5 个核心页面和 3 个 JSON-RPC API，所有指标均在目标范围内（页面 < 2s，API < 500ms）。

**性能基线**：

| 指标 | 目标值 | 测量方式 |
|------|--------|---------|
| 列表页加载 | < 2s（100 条） | 浏览器 Network 面板 |
| 表单页加载 | < 1.5s | 浏览器 Network 面板 |
| 报表生成 | < 5s（月度报表） | 页面加载完成时间 |
| API 响应 | < 500ms | curl 计时 |
| 并发用户 | ≥ 10 用户无降级 | 压力测试工具 |

**输出**：性能测试报告（填入模板 Part 3）

### Step 4: 安全审计

**做什么**：验证权限配置、数据安全和系统配置的安全性，确保无 P0/P1 安全漏洞。

**AI 引导问题**：
1. RBAC 权限矩阵是否在 Phase 1 已定义？实际配置是否与设计一致？
2. 有没有敏感数据需要特殊保护？（如：供应商价格、财务数据、员工薪资）
3. 系统是否暴露在公网？需要什么级别的安全加固？

**操作要点**：
- **权限验证**：按 RBAC 矩阵，用每个角色账号登录，验证只能访问授权功能
- **记录规则检查**：验证 `ir.rule` 配置，确保跨公司/跨部门数据隔离
- **敏感操作审计**：删除、批量修改、权限变更等操作是否有日志记录
- **Odoo 安全配置检查清单**：
  - `list_db = False`（禁止数据库列表暴露）
  - `admin_passwd` 已修改（非默认值）
  - `proxy_mode = True`（如在 Nginx 后面）
  - HTTPS 强制启用
  - Session 超时配置合理
  - 文件上传大小限制

**安全审计分级**：

| 级别 | 定义 | 处理要求 |
|------|------|---------|
| **P0** | 权限绕过 / 数据泄露 / 未授权访问 | 立即修复，阻塞上线 |
| **P1** | 敏感操作无日志 / 弱密码策略 | 上线前修复 |
| **P2** | 配置不规范但无直接风险 | 上线后 Sprint 内修复 |

**输出**：安全审计报告（填入模板 Part 4）

## 测试类型定义

| 测试类型 | 执行时机 | 执行方式 | 通过标准 |
|---------|---------|---------|---------|
| 单元测试 | Phase 2 每次提交 | `pytest` 自动化 | 覆盖率 ≥ 80% |
| 集成测试 | Phase 3 Step 1 | Odoo HttpCase 脚本 | 所有 E2E 流程通过 |
| UAT 验收 | Phase 3 Step 2 | 业务方手动操作 | 判定标准见 Step 2 |
| 性能测试 | Phase 3 Step 3 | 工具测量 | 所有指标达标 |
| 安全审计 | Phase 3 Step 4 | 人工检查 + 工具辅助 | 无 P0/P1 漏洞 |

## 模板

空白模板：[模板-测试报告.md](./模板-测试报告.md)（复制到项目层使用）

## 检查清单

- [ ] 端到端集成测试覆盖所有核心业务流程（≥ 5 条）
- [ ] 每条 E2E 流程的预期结果 vs 实际结果已记录
- [ ] UAT 场景 100% 来源于 BDD 行为规格
- [ ] UAT 业务方签字确认（或邮件确认）
- [ ] 所有 P0/P1 缺陷已修复并重测通过
- [ ] 性能基线所有指标达标
- [ ] 慢查询已优化（无 > 1s 的 SQL 查询）
- [ ] RBAC 权限验证覆盖所有角色
- [ ] Odoo 安全配置检查清单全部通过
- [ ] 安全审计无 P0/P1 漏洞

## 输出

- 集成测试报告（E2E 流程测试结果）
- UAT 测试报告（业务方签字确认）
- 性能测试报告（含性能基线达标情况）
- 安全审计报告（含漏洞分级和修复状态）

## 方法论引用

- [05-质量框架](../../00-方法论/05-质量框架/README.md)（五层防线 L3/L4、上线门禁、缺陷分级）
- [04-设计模式/BDD](../../00-方法论/04-设计模式与开发实践/README.md)（行为规格作为 UAT 用例）
- [SDLC Phase 3](../../00-方法论/02-过程方法论/sdlc.md)（测试验收是 Phase 3 第一大活动）

---

## 变更记录

| 版本 | 日期 | 修改内容 |
|------|------|---------|
| v0.1.0 | 2026-02-16 | 纲要创建 |
| v0.2.0 | 2026-02-17 | 细化 4 个步骤：AI 引导问题、操作要点、E2E 流程清单、UAT 判定标准、性能基线、安全审计分级、测试类型定义表 |
| v0.3.0 | 2026-02-17 | Phase 3 试跑验证：新增 Odoo 测试框架实操经验（5 条）、1 人 UAT 模式、curl 简易性能基线方法、状态更新为"已验证" |
