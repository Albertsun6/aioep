# 07 - AI 协作协议

> 状态: **已确认** | 版本: v0.2.0 | 创建: 2026-02-15 | 更新: 2026-02-15

## 定位

定义项目"怎么与 AI 协作"。核心原则 P9（AI 可信但必须被理解）的执行框架。规范 AI 的输出标准、审查流程和知识传承机制。**立即生效**。

---

## 1. 代码输出规范

### 1.1 AI 生成代码三段说明

AI 生成的每段代码必须包含：

```python
# --- AI 生成说明 ---
# 功能：[做了什么] 简要描述代码功能
# 决策：[为什么这样做] 设计决策的理由，如选用了哪个 Odoo 机制、为什么不用其他方式
# 风险：[有什么风险] 已知限制、潜在问题、需要人工确认的地方。无风险则写"无已知风险"
# ---
```

### 1.2 代码注释四级规范

| 级别 | 位置 | 必须包含 | 示例 |
|------|------|---------|------|
| **文件级** | 文件顶部 | 模块用途、作者、依赖说明 | `"""采购订单扩展：增加审批流和供应商评级"""` |
| **类级** | class 下方 | 模型用途、关键字段说明、业务规则摘要 | `"""采购订单模型扩展。新增字段：approval_state, supplier_rating。业务规则：金额>5万需总监审批"""` |
| **方法级** | def 下方 | 功能描述、参数说明、返回值、副作用 | Google 风格 docstring |
| **行内** | 复杂逻辑旁 | 解释"为什么"而非"做了什么" | `# 使用 sudo() 因为审批人可能无此模型写权限` |

**规则**：
- 文件级和类级注释使用中文（面向业务理解）
- 方法级 docstring 使用中文，参数类型用 Python type hint
- 行内注释：简单逻辑不需要注释，复杂/反直觉/涉及 Odoo 魔法的必须注释
- AI 生成的代码段用 `# AI Generated` 标记开头（便于后续统计和审计）

### 1.3 文档输出规范

- AI 生成的文档必须在头部标注：`> 由 AI 生成，待人工审阅`
- 人工确认后改为：`> 已审阅确认` 并注明审阅日期
- 关键决策类内容（架构选型、技术方案）必须人工确认后才能作为后续工作的依据

### 1.4 建模输出规范

- AI 生成的 Mermaid 图定位为**草稿**，用于快速沟通和讨论
- Mermaid 草稿不等同于正式模型
- 正式模型需在 GUI 工具（draw.io / Archi）中人工绘制或确认
- 转换流程：AI 生成 Mermaid → 人工审查逻辑正确性 → 在 draw.io 中绘制正式版 → 导出到 `models/exports/`

---

## 2. AI 审查流程

### 2.1 审查流程图

```
AI 生成代码/文档
    ↓
自动检查（Pre-commit: pylint-odoo + flake8 + black + xmllint）
    ↓
人工审查（按 2.2 清单）
    ├── 通过 → 合入代码 → 更新文档 → 记录 Chatlog
    └── 不通过 → 反馈修改要求 → AI 修改 → 重新审查
```

### 2.2 审查清单

以下清单复用并扩展自 [03-开发平台规划 6.2](../../03-开发平台规划.md) 的代码审查检查项：

**快速审查**（所有代码提交必做，5~10 分钟）：

| # | 检查项 | 要点 |
|---|--------|------|
| 1 | 功能完整性 | 模型字段完整、视图覆盖 form/tree/search、权限已配置 |
| 2 | Odoo 规范 | `_name` 命名规范（`erp.xxx`）、使用 `_inherit` 不改源码、XML ID 命名约定 |
| 3 | 安全基础 | `ir.model.access.csv` 完整、无裸 SQL 拼接、无硬编码密码 |
| 4 | 代码风格 | 通过 pylint-odoo / flake8 / black 检查 |
| 5 | 注释完整 | 文件级和类级注释存在、复杂逻辑有行内注释 |
| 6 | 测试存在 | 核心逻辑有对应测试用例 |

**深度审查**（以下场景触发，30~60 分钟）：

| 触发条件 | 额外检查 |
|---------|---------|
| 涉及财务计算 | 验证计算公式、精度处理（Decimal）、并发安全 |
| 涉及权限/安全 | 验证记录规则、字段级权限、越权测试 |
| 涉及 Odoo 核心模型继承 | 验证与标准模块兼容性、升级影响评估 |
| 涉及外部服务通信 | 验证超时处理、重试逻辑、异常处理、数据校验 |
| 涉及数据迁移 | 验证可逆性、大数据量性能、备份策略 |
| 新模块首次提交 | 完整走一遍全部清单 |

### 2.3 审查结果记录

- 审查结果记录在 Git commit message 或 PR 评论中
- 重要的审查发现（如设计缺陷、安全风险）同步记录到 Chatlog

---

## 3. Chatlog 规范

Chatlog（`docs/Chatlog.md`）是**正式项目文档**，不是聊天记录。

### 3.1 每条记录必须包含

| 字段 | 要求 |
|------|------|
| 时间戳 | YYYY-MM-DD HH:mm |
| 对话标题 | 简短描述本次对话目的 |
| 用户需求 | 原始问题或需求描述 |
| 解决方案 | AI 的回复摘要和关键步骤 |
| 代码改动 | 修改/新增/删除的文件列表及简要说明 |
| 关键决策 | 本次对话中做出的重要决策及理由（如有） |
| 状态标签 | ✅完成 / ⏳进行中 / ❌未解决 |

### 3.2 Chatlog 的价值

- 为后续 AI 对话提供上下文连续性（如换电脑、新对话窗口时首先读 Chatlog）
- 记录关键决策的理由（满足 P4 全链路可追溯）
- 支持项目审计和知识传承（满足 P8 知识沉淀）

---

## 4. AI 上下文管理

### 4.1 上下文层次

```
永久上下文（每次对话自动加载）：
├── .cursor/rules/        → 编码规范、项目约定（Cursor 自动读取）
└── 项目文件结构           → Cursor 自动感知

会话历史（跨对话传承）：
└── docs/Chatlog.md       → 关键决策和上下文记录（需手动引用或 AI 主动读取）

按需上下文（特定任务时加载）：
├── docs/00-方法论/        → 方法论文档（涉及规范时引用）
├── docs/01~05            → 项目文档（涉及架构/规划时引用）
└── .cursor/skills/       → Skills（未来自动触发）
```

### 4.2 上下文恢复流程

当开始新的对话（如换电脑、新窗口、AI 上下文丢失）时，按以下步骤恢复：

1. **读 Chatlog**：`docs/Chatlog.md` — 了解最近做到哪、有什么决策
2. **读项目路线图**：`docs/05-项目路线图.md` — 确认当前处于哪个 Phase、什么里程碑
3. **读核心原则**：`docs/00-方法论/01-核心原则/README.md` — 刷新原则约束
4. **按任务读相关文档**：根据当前任务，引用对应的项目文档或方法论文档
5. **确认后继续**：向用户确认当前进度和下一步，避免重复工作

> 这正是你换电脑后我们所做的事情。

### 4.3 Cursor Rules 规划

Phase 0 需要编写 6 个 Cursor Rules 文件，主题已在 [03-开发平台规划 4.1](../../03-开发平台规划.md) 中详细规划：

| Rules 文件 | 核心约束 | 对应原则 |
|-----------|---------|---------|
| `odoo-development.md` | 模块命名、模型命名、继承规范、视图规范 | P2 透明、P4 追溯 |
| `python-style.md` | PEP 8、类型注解、Docstring、Import 顺序 | P1 质量 |
| `xml-views.md` | Form/Tree/Search 标准结构、继承 xpath | P1 质量 |
| `security-rules.md` | 权限必配、记录规则、敏感数据处理 | P10 安全 |
| `testing.md` | 测试命名、覆盖率要求、测试数据规范 | P5 可验证 |
| `git-workflow.md` | 分支策略、提交格式、PR 规范 | P4 追溯、P6 可回退 |

> Rules 的具体内容在 Phase 0 的"AI 工具链配置"阶段编写，此处只做主题确认。

---

## 5. Skills 规划（暂不执行）

待方法论文档体系稳定且进入开发阶段后，按需创建以下 Cursor Skills：

| Skill | 触发场景 | 优先级 |
|-------|---------|--------|
| odoo-module-create | "创建模块" | Phase 1 |
| odoo-model-design | "设计数据模型" | Phase 1 |
| bpmn-process-design | "梳理业务流程" | Phase 1 |
| quality-review | "审查代码/模型" | Phase 2 |
| sprint-workflow | "开始 Sprint" | Phase 2 |

---

## 6. 执行细则引用

[docs/02-AI驱动开发方法论.md](../../02-AI驱动开发方法论.md) 作为本协议的**执行细则**，包含：
- 日常开发节奏（每日 AI 协作流程）
- Sprint 内 AI 协作流程
- AI 输出质量保障四层防线的操作细节
- 人机分工矩阵

本协议定义"标准和规范"，执行细则定义"日常如何操作"。

---

## 与其他文档的关系

- **上游**：[01-核心原则](../01-核心原则/README.md)（P9 AI 可信但必须被理解、P8 知识沉淀）
- **执行细则**：[docs/02-AI驱动开发方法论.md](../../02-AI驱动开发方法论.md)
- **质量配合**：[05-质量框架](../05-质量框架/README.md)（L1 AI 规则层）
- **审查清单来源**：[docs/03-开发平台规划.md 6.2](../../03-开发平台规划.md)
- **建模配合**：[03-建模体系](../03-建模体系/README.md)（AI Mermaid 草稿标准）

---

## 变更记录

| 版本 | 日期 | 修改内容 |
|------|------|---------|
| v0.1.0 | 2026-02-15 | 纲要创建 |
| v0.2.0 | 2026-02-15 | 填充代码注释规范、审查清单、上下文恢复流程、Cursor Rules 确认 |
