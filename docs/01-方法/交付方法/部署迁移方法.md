# 部署迁移方法

> 状态: **已验证** | 版本: v0.3.0 | 创建: 2026-02-16 | 上次验证: 2026-02-17（ERP 项目 Phase 3 试跑）

## 定位

指导如何从 Odoo 14 迁移到 Odoo 17，以及如何将系统从开发/测试环境部署到生产环境。对应 SDLC Phase 3 的第二大活动。

适用于 Docker 容器化部署方式，1 人 + AI 开发模式下的安全部署策略。核心原则：**可回滚、可验证、最小停机**。

## 前置条件

- 测试验收方法全部步骤完成（集成测试 + UAT + 性能 + 安全审计均通过）
- 上线门禁已通过（质量框架定义）
- 生产环境硬件/网络就绪
- 数据迁移脚本开发完成且在 staging 验证通过
- 回滚方案已演练

## 步骤

### Step 1: 生产环境准备

**做什么**：搭建生产级基础设施，确保服务器配置、容器编排、SSL、监控和备份全部就绪。

**AI 引导问题**：
1. 生产服务器的规格是什么？（CPU/内存/存储/网络带宽）
2. 是否需要高可用？（单机 vs 主备，1 人项目通常单机即可）
3. 域名和 SSL 证书准备好了吗？
4. 备份存储在哪里？（本地磁盘 / 云存储 / 异地备份）

**操作要点**：
- **Docker Compose 生产配置**：
  - 独立的 `docker-compose.prod.yml`（区别于开发环境）
  - 环境变量通过 `.env` 文件管理（不提交到 Git）
  - 数据卷挂载到宿主机（持久化）
  - 限制容器资源（CPU/内存 limits）

> **Dev/Prod 配置分离最佳实践**（试跑经验）：
> - 必须使用独立文件：`docker-compose.yml`（dev）vs `docker-compose.prod.yml`（prod）
> - Odoo 配置同理：`odoo.conf`（dev）vs `odoo.prod.conf`（prod）
> - 关键差异点：`list_db`、`admin_passwd`、`workers`、`proxy_mode`、`--dev` 参数
> - 自定义模块挂载：dev 用 `rw`（可热更新），prod 用 `ro`（只读，防止运行时修改）
> - 试跑中创建了完整的 `docker-compose.prod.yml`（含 Nginx + Redis + 资源限制），可作为参考模板
- **Nginx 反向代理**：
  - SSL 证书配置（Let's Encrypt 自动续签推荐）
  - HTTP → HTTPS 强制跳转
  - 静态文件缓存（`/web/static/`）
  - 请求大小限制（`client_max_body_size`）
- **PostgreSQL 生产调优**：
  - `shared_buffers = RAM * 25%`
  - `work_mem = 64MB`
  - `effective_cache_size = RAM * 75%`
  - `max_connections` 对齐 Odoo workers
- **监控**：
  - 基础：`docker stats` + 磁盘空间检查 cron
  - 推荐：Prometheus + Grafana（监控 CPU/内存/磁盘/响应时间）
  - Odoo 日志集中收集（`stdout` → 宿主机日志目录）
- **备份策略**：
  - `pg_dump` 每日自动备份（cron 定时任务）
  - 文件存储（filestore）同步备份
  - 至少保留 7 天历史备份
  - 每月验证备份可恢复性

> **备份脚本模式**（试跑经验）：建议将备份逻辑封装为 `scripts/backup.sh`，包含：(1) `docker exec pg_dump | gzip` 数据库备份、(2) `docker exec tar czf` filestore 备份、(3) `find -mtime +N -delete` 过期清理。试跑中创建的脚本已验证可用。

**输出**：生产环境配置清单（填入模板 Section 1）

### Step 2: 数据迁移

**做什么**：将 Odoo 14 的历史业务数据迁移到 Odoo 17 新系统中，确保数据完整性和正确性。

**AI 引导问题**：
1. 哪些数据必须迁移？（主数据/交易数据/配置数据/附件）
2. 迁移策略选择：全量迁移 vs 增量迁移 vs 只迁移主数据？
3. 数据清洗需求？（历史脏数据是否趁机清理）
4. 双系统并行期需要多长？（迁移窗口）

**操作要点**：
- **迁移策略选择**：
  - 推荐"主数据全量 + 交易数据截止日"策略（减少迁移量）
  - 历史交易（如 > 2 年前的订单）可只迁移汇总/不迁移
  - 附件按需迁移（通常只迁移活跃记录的附件）
- **字段映射**：
  - 建立 Odoo 14 → Odoo 17 的字段映射表（模型名、字段名、类型变化）
  - 注意 Odoo 14→17 的 breaking changes（如 accounting 模块重构）
  - 自定义字段需要单独处理
- **迁移脚本模式**：
  - 使用 `xmlrpc` / JSON-RPC 读取旧系统、写入新系统
  - 或导出 CSV → 转换 → 导入 CSV（适合简单模型）
  - 每个模型一个迁移脚本，按依赖顺序执行
- **数据校验**：
  - 记录数对比（旧系统 vs 新系统）
  - 金额汇总对比（总采购额、总销售额、库存价值）
  - 关键字段抽样检查（随机抽 5%）
  - 关联完整性检查（如 PO 的供应商是否都存在）

**迁移数据分类表**：

| 分类 | 说明 | 示例 | 迁移策略 |
|------|------|------|---------|
| **主数据** | 业务实体基础信息 | 产品、供应商、客户、仓库 | 全量迁移 |
| **交易数据** | 业务单据和流水 | PO、SO、Invoice、Stock Move | 截止日迁移 |
| **配置数据** | 系统配置和规则 | 审批规则、价格表、税率 | 重新配置（推荐） |
| **附件** | 文件和图片 | 产品图片、合同扫描件 | 按需迁移 |

**输出**：数据迁移报告（填入模板 Section 2）

### Step 3: 部署执行

**做什么**：将测试通过的系统部署到生产环境，执行数据迁移，完成系统切换。

**AI 引导问题**：
1. 停机窗口安排在什么时间？（建议周末或下班后）
2. 是否需要通知用户停机计划？
3. DNS 切换由谁负责？TTL 是否已提前调低？

**操作要点**：
- **部署前准备**（T-1 天）：
  - 生产数据库最终备份
  - 确认所有自定义模块版本与 staging 一致
  - DNS TTL 调低至 300s（为快速切换做准备）
  - 通知相关人员停机时间和预估恢复时间
- **部署执行**（T 时刻）：
  - 旧系统设为只读（或停止接受新单据）
  - 执行最终数据迁移（增量部分）
  - `docker-compose -f docker-compose.prod.yml up -d`
  - 运行 Odoo 模块升级：`odoo -u all -d [db] --stop-after-init`
  - 数据迁移校验（记录数 + 金额汇总）
  - DNS 切换指向新服务器
  - SSL 证书验证
- **部署后验证**：
  - 核心页面可访问性检查
  - 管理员登录 → 基本操作验证
  - 一条完整业务流程走通（如创建 PO → 收货 → 付款）

**部署时间线示例**：

| 时间 | 活动 | 负责人 | 预计耗时 |
|------|------|--------|---------|
| T+0:00 | 旧系统设为只读 | 运维 | 5 min |
| T+0:05 | 最终增量数据迁移 | 开发 | 30 min |
| T+0:35 | 新系统部署启动 | 开发 | 15 min |
| T+0:50 | 数据迁移校验 | 开发 | 20 min |
| T+1:10 | DNS 切换 | 运维 | 5 min |
| T+1:15 | 部署后验证 | 开发 | 15 min |
| T+1:30 | 宣布上线完成 | PM | - |

**输出**：部署执行记录（填入模板 Section 3）

### Step 4: 回滚演练

**做什么**：提前演练回滚流程，确保在部署失败时能快速恢复到旧系统。回滚演练**必须在正式部署前完成**。

**AI 引导问题**：
1. 回滚触发条件是什么？（哪些情况下决定回滚）
2. 回滚后数据如何处理？（部署期间产生的新数据）
3. 回滚时间窗口是多少？（超过多久不再回滚，选择前滚修复）

**操作要点**：
- **回滚触发条件**（任一满足即触发）：
  - 核心页面无法访问且 15 分钟内无法修复
  - 数据迁移校验发现金额不一致
  - P0 缺陷出现且无法快速修复
  - 部署执行超时（超过预计时间 2 倍）
- **回滚步骤**：
  1. 停止新系统容器
  2. 恢复旧数据库备份（`pg_restore`）
  3. DNS 切回旧服务器（或恢复旧容器）
  4. 验证旧系统正常运行
  5. 通知相关人员回滚完成和后续计划
- **回滚演练要求**：
  - 在 staging 环境至少完整演练 1 次
  - 记录回滚耗时（目标 < 30 分钟）
  - 验证回滚后数据完整性

> **试跑经验**：Docker 化部署的回滚速度极快。试跑中完整回滚演练（停容器 → `pg_restore` → 重启 → 健康检查）仅耗时 6 秒。Docker 环境下回滚应作为**必做项**而非可选项——成本极低但安全收益极高。

**回滚决策矩阵**：

| 场景 | 严重程度 | 决策 | 时间窗口 |
|------|---------|------|---------|
| 核心功能不可用 | 高 | 立即回滚 | 15 min |
| 数据不一致 | 高 | 评估后回滚 | 30 min |
| 非核心功能异常 | 中 | 前滚修复 | 2h |
| 性能问题 | 低 | 在线调优 | 4h |
| 上线超过 24h | - | 不再回滚，前滚 | - |

**输出**：回滚演练记录（填入模板 Section 4）

### Step 5: 健康检查

**做什么**：上线后进行系统全面健康检查，确认所有服务正常运行。健康检查在部署后立即执行，并在后续 1 周内每日重复。

**AI 引导问题**：
1. 哪些指标需要持续监控？
2. 告警阈值如何设置？
3. 值班安排如何？（1 人项目需确保手机能收到告警）

**操作要点**：
- **即时健康检查**（上线后 30 分钟内）：
  - Odoo 服务状态：`curl -s -o /dev/null -w "%{http_code}" https://[domain]/web/login`
  - 数据库连接：`docker exec [db_container] pg_isready`
  - Nginx 状态：`nginx -t && systemctl status nginx`
  - 磁盘空间：`df -h`（确保 > 20% 可用）
  - 容器状态：`docker ps`（所有容器 Up 且无 Restart）
  - 日志检查：`docker logs [odoo_container] --tail 100`（无 ERROR / CRITICAL）
- **核心页面可访问性**：
  - 登录页 → 登录成功
  - 采购订单列表 → 加载正常
  - 库存看板 → 加载正常
  - 创建新单据 → 保存成功
- **每日健康检查**（上线后 1 周）：
  - 数据库大小变化趋势
  - 错误日志统计
  - 响应时间趋势
  - 用户反馈收集

**健康检查项速查表**：

| 检查项 | 命令/方式 | 正常标志 | 频率 |
|--------|---------|---------|------|
| Odoo 服务 | HTTP 200 检查 | 状态码 200 | 每 5 min |
| 数据库 | `pg_isready` | accepting connections | 每 5 min |
| 磁盘空间 | `df -h` | > 20% 可用 | 每小时 |
| 容器状态 | `docker ps` | Up 无 Restart | 每 5 min |
| 错误日志 | `grep ERROR` | 无新 ERROR | 每小时 |
| 响应时间 | HTTP 响应计时 | < 2s | 每 5 min |
| 备份状态 | 检查备份文件 | 当日备份存在 | 每日 |

**输出**：健康检查报告（填入模板 Section 5）

## 迁移数据分类定义

| 分类 | 特征 | 迁移优先级 | 校验方式 |
|------|------|-----------|---------|
| **主数据** | 相对稳定、被广泛引用 | P0 必须迁移 | 记录数 + 抽样 |
| **交易数据** | 持续增长、有时间属性 | P1 按策略迁移 | 记录数 + 金额汇总 |
| **配置数据** | 数量少、影响面大 | P0 重新配置 | 功能验证 |
| **附件** | 体积大、非结构化 | P2 按需迁移 | 文件数 + 大小 |

## 模板

空白模板：[模板-部署检查清单.md](./模板-部署检查清单.md)（复制到项目层使用）

## 检查清单

- [ ] 生产 Docker Compose 配置与 staging 一致
- [ ] Nginx + SSL 配置完成并测试通过
- [ ] PostgreSQL 生产参数已调优
- [ ] 自动备份 cron 已配置并验证
- [ ] 数据迁移脚本在 staging 验证通过
- [ ] 迁移数据校验规则已定义（记录数 + 金额 + 抽样）
- [ ] 回滚方案已在 staging 演练且回滚耗时 < 30 min
- [ ] 部署时间线已确认，相关人员已通知
- [ ] 健康检查脚本/命令已准备
- [ ] 监控告警已配置（至少磁盘 + 服务状态）

## 输出

- 生产环境配置清单
- 数据迁移报告（含校验结果）
- 部署执行记录（时间线 + 验证结果）
- 回滚演练记录
- 上线后健康检查报告

## 方法论引用

- [05-质量框架](../../00-方法论/05-质量框架/README.md)（上线门禁、五层防线 L5 生产监控）
- [SDLC Phase 3](../../00-方法论/02-过程方法论/sdlc.md)（部署迁移是 Phase 3 第二大活动）
- [测试验收方法](./测试验收方法.md)（部署前置条件：测试全部通过）

---

## 变更记录

| 版本 | 日期 | 修改内容 |
|------|------|---------|
| v0.1.0 | 2026-02-16 | 纲要创建 |
| v0.2.0 | 2026-02-17 | 细化 5 个步骤：生产环境配置、数据迁移策略、部署执行时间线、回滚决策矩阵、健康检查速查表、迁移数据分类定义 |
| v0.3.0 | 2026-02-17 | Phase 3 试跑验证：新增 Dev/Prod 配置分离最佳实践、回滚演练实测数据（6 秒）、备份脚本模式、状态更新为"已验证" |
