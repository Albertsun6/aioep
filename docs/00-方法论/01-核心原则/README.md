# 01 - 核心原则

> 状态: **已确认** | 版本: v0.2.0 | 创建: 2026-02-15 | 更新: 2026-02-15

## 定位

项目的 10 条不可违背的原则。所有决策、设计、代码和文档都必须符合这些原则。当原则之间冲突时，编号靠前的优先级更高。

## 原则总览

| 编号 | 原则 | 一句话定义 |
|------|------|----------|
| P1 | 质量可控 | 每个工件都有验收标准，每个阶段都有质量门禁 |
| P2 | 全面透明 | 系统任何行为都可被相应角色理解和审查 |
| P3 | 结构化表达 | 用建模语言而非纯自然语言表达系统行为 |
| P4 | 全链路可追溯 | 需求→设计→代码→测试全程有迹可循 |
| P5 | 可验证 | 任何关于系统的声明都能通过测试或演示证明 |
| P6 | 可回退 | 每一步变更都可以撤销 |
| P7 | 渐进交付 | 小步快跑，每个增量是完整业务切片 |
| P8 | 知识沉淀 | 知识在项目中（文档/代码/模型），不在人脑中 |
| P9 | AI 可信但必须被理解 | AI 产出是起点不是终点 |
| P10 | 安全内建 | 权限、审计、数据保护从设计开始 |

---

## 原则详述

### P1 质量可控

**定义**：每个工件（代码、模型、文档、配置）都有明确的验收标准，每个阶段转换都有质量门禁。质量问题一票否决进度。

**为什么**：ERP 是企业核心业务系统，质量缺陷直接导致财务数据错误、库存不准、订单丢失。上线后修复成本是开发期的 10 倍以上。

**怎么做**：
- 每个阶段转换必须通过质量门禁 → 门禁清单见 [05-质量框架](../05-质量框架/README.md)
- 代码提交前必须通过 pre-commit 检查（pylint-odoo + flake8 + black + xmllint）→ 工具链见 [03-开发平台规划 6.1](../../03-开发平台规划.md)
- 测试覆盖率 ≥ 80%，核心业务逻辑 100% 覆盖 → 度量指标见 [05-质量框架](../05-质量框架/README.md)
- 每个模块交付时必须包含：功能测试 + 权限测试 + 边界测试

**违反后果**：质量门禁未通过时，阻塞阶段转换，不允许进入下一阶段。已发现的 P0/P1 缺陷未修复前不允许合入 develop 分支。

---

### P2 全面透明

**定义**：系统的任何行为都可以被相应角色理解和审查。不允许存在无法解释的黑盒。AI 生成的代码、Odoo 框架行为、业务逻辑、数据流转——全部透明可查。

**为什么**：ERP 涉及财务审计和业务合规，系统中不可解释的行为会导致审计风险。Odoo 框架的"魔法"（如自动工作流、信号触发）如果不文档化，后续维护将极其困难。

**怎么做**：
- AI 生成的代码必须标注 `# AI Generated` 并附设计决策说明 → 注释规范见 [07-AI协作协议](../07-AI协作协议/README.md)
- Odoo 框架隐式行为（如 `_inherit` 的字段合并、`mail.thread` 的自动通知）在模块文档中显式说明
- 关键业务流程用 BPMN 或 Mermaid 图表达，不接受纯口头描述 → 建模标准见 [03-建模体系](../03-建模体系/README.md)
- 数据流转路径（从用户操作到数据库写入）在模块设计文档中记录

**违反后果**：代码审查时，无法解释"为什么这样写"的代码不允许合入。缺少流程图的核心业务模块不通过 Sprint 完成门禁。

---

### P3 结构化表达

**定义**：用建模语言（ArchiMate / BPMN / UML / C4 / 决策表 / 伪代码）表达系统行为和业务逻辑。关键逻辑不接受纯自然语言描述。

**为什么**：自然语言存在歧义（"订单完成后通知"——谁通知、通知谁、什么算完成？）。建模语言强制精确表达，减少沟通成本和实现偏差。

**怎么做**：
- 核心业务流程必须有 BPMN 或 Mermaid 流程图（至少覆盖采购/销售/库存/财务的主流程）
- 数据模型用 UML 类图或 Mermaid classDiagram 表达字段和关联关系
- 系统间交互用序列图表达（Odoo ↔ 外部服务 ↔ 第三方）
- 渐进式要求：Phase 1~2 用 Mermaid 草图即可，Phase 3+ 核心模块补充 draw.io 正式图 → 成熟度见 [03-建模体系](../03-建模体系/README.md)

**违反后果**：核心业务模块缺少流程图或数据模型图的，不通过模块评审。需求文档中纯文字描述的复杂逻辑，需补充结构化表达后方可进入开发。

---

### P4 全链路可追溯

**定义**：从需求到设计到代码到测试，每一步都有迹可循。数据在系统中的流转路径从源头到终点清清楚楚。

**为什么**：当线上出现问题时，需要快速定位"这个功能是基于什么需求做的、设计方案是什么、谁写的代码、测试覆盖了没有"。没有追溯链，排查问题和回归修复的成本会指数增长。

**怎么做**：
- Git commit message 必须关联需求编号（格式：`feat(sale): [REQ-001] 添加审批功能`）→ 提交规范见 [03-开发平台规划 7.2](../../03-开发平台规划.md)
- 每个模块的设计文档中记录"基于哪些需求"
- 测试用例与需求/功能点对应，命名体现测试对象（如 `test_sale_order_approval_flow`）
- Chatlog 记录关键决策和理由 → 格式见 [07-AI协作协议](../07-AI协作协议/README.md)

**违反后果**：无法追溯到需求来源的功能代码，在代码审查时标记为"需补充追溯信息"。无对应测试的功能不允许标记为"完成"。

---

### P5 可验证

**定义**：任何关于系统的声明都能通过测试或演示来证明。"这个功能做好了"必须有测试用例支撑，不接受口头声明。

**为什么**：ERP 系统业务逻辑复杂（价格计算、库存扣减、审批流程），靠人工验证容易遗漏边界情况。自动化测试是唯一可靠的、可重复的验证手段。

**怎么做**：
- 每个模型的 CRUD 操作有基础测试（继承 `TransactionCase`）
- 核心业务逻辑有行为测试（如：创建销售订单 → 确认 → 出库 → 收款，端到端流程）
- 测试覆盖率 ≥ 80%，通过 `pytest --cov` 度量 → 目标值见 [05-质量框架](../05-质量框架/README.md)
- Sprint Review 时必须做功能演示（Demo），不接受"功能已完成但还没测试"的说法

**违反后果**：未通过测试的功能不计入 Sprint 完成度。测试覆盖率低于阈值时，Sprint 完成门禁不通过。

---

### P6 可回退

**定义**：每一步变更都可以撤销。数据库迁移可逆，功能可通过配置关闭，代码可通过 Git 回滚。

**为什么**：ERP 上线后直接影响业务运转，一旦新版本出现严重问题，必须能在分钟级恢复到上一个稳定版本。不可逆的变更是最大的部署风险。

**怎么做**：
- Git 分支策略：main 分支始终是可部署的稳定版本，通过 Git revert 可快速回滚 → 分支策略见 [03-开发平台规划 7.1](../../03-开发平台规划.md)
- Odoo 数据迁移：每个模块升级脚本（`pre_init_hook` / `post_init_hook`）必须有对应的降级逻辑；不可逆迁移需在设计评审时标注风险
- 数据库备份：每次部署前自动备份，保留最近 30 天 → 备份策略见 [04-系统架构设计 4.2](../../04-系统架构设计.md)
- 功能开关：大功能通过系统配置参数（`ir.config_parameter`）控制启停，灰度发布

**违反后果**：不可逆的数据库变更需要经过额外的设计评审和审批。缺少回滚方案的部署计划不允许执行。

---

### P7 渐进交付

**定义**：小步快跑，每个迭代增量都是完整的业务切片，可以独立部署和验证。不做"大爆炸"上线。

**为什么**：1 人 + AI 的开发模式下，大批量集成风险极高。每次交付一个完整切片（模型 + 视图 + 权限 + 测试），可以尽早发现问题、获得反馈。

**怎么做**：
- 按模块分阶段上线：erp_base → erp_purchase / erp_sale → erp_stock → erp_account → erp_report → erp_integration → 上线顺序见 [05-项目路线图](../../05-项目路线图.md)
- "完整的业务切片"定义：一个切片至少包含 1 个可用的业务流程（如"采购申请→审批→生成订单"），而非孤立的数据模型
- Sprint 周期 2~3 周，每个 Sprint 结束时有可演示的功能增量
- 每个模块交付物：代码 + 测试 + 权限 + 文档 + 演示数据，缺一不可

**违反后果**：超过 1 个 Sprint 未产出可演示的增量时，需停下来分析原因（任务拆分过大？技术障碍？）。不允许"攒多个模块一起上线"。

---

### P8 知识沉淀

**定义**：项目知识存在于项目中（文档、代码注释、模型文件、Chatlog），不存在于任何人的脑中。任何人（包括 AI）的离开都不会导致知识丢失。

**为什么**：AI 对话上下文有限且不持久，换一次对话窗口就可能丢失之前的决策理由。项目知识必须持久化到文件中，才能保证连续性（正如你换电脑后靠 Chatlog 接上进度）。

**怎么做**：
- 文档体系：项目文档（docs/01~05）+ 方法论（docs/00-方法论/）+ 模块文档（docs/modules/）→ 结构见 [03-开发平台规划 2](../../03-开发平台规划.md)
- AI 上下文传承：Cursor Rules（编码规范，每次对话自动加载）+ Chatlog（关键决策记录，按需引用）→ 规范见 [07-AI协作协议](../07-AI协作协议/README.md)
- 代码注释：不仅写"做了什么"，更写"为什么这样做"（设计意图级注释）→ 注释规范见 [07-AI协作协议](../07-AI协作协议/README.md)
- 模型文件：.drawio / .archimate 源文件纳入 Git，修改时导出 PNG 到 `models/exports/`

**违反后果**：仅存在于口头或临时笔记中的决策需补录到 Chatlog 或相应文档。代码审查时，缺少设计意图注释的复杂逻辑需补充后合入。

---

### P9 AI 可信但必须被理解

**定义**：AI 的产出是开发的起点，不是终点。每一行 AI 生成的代码都必须有人能解释"为什么这样写"。不理解的代码不允许合入。

**为什么**：AI 可能生成看起来正确但存在隐患的代码（如 Odoo ORM 的 N+1 查询、不安全的 SQL 拼接、错误的权限配置）。盲目信任会在后期造成难以排查的问题。

**怎么做**：
- AI 生成的每段代码必须附带"功能/决策/风险"三段说明 → 输出规范见 [07-AI协作协议](../07-AI协作协议/README.md)
- 人工审查 AI 代码时，重点检查：业务逻辑正确性、Odoo ORM 用法、安全性、性能 → 审查清单见 [07-AI协作协议](../07-AI协作协议/README.md)
- AI 生成的 Mermaid 图是"草稿"，不等同于正式模型。核心模块的正式模型需在 draw.io 中人工确认
- 遇到 AI 无法解释清楚的建议时，先查 Odoo 官方文档或源码确认，再决定是否采纳

**违反后果**：代码审查时，开发者无法解释的 AI 代码段不允许合入（标记为"需理解后重新提交"）。

---

### P10 安全内建

**定义**：权限控制、审计日志、数据保护从系统设计阶段开始内建，不是上线前临时补丁。

**为什么**：ERP 系统包含财务数据、客户信息、供应商合同等敏感信息。安全问题事后补救的成本远高于设计阶段内建，且可能造成不可逆的数据泄露。

**怎么做**：
- 每个模型必须配置 `ir.model.access.csv`（访问控制），核心模型必须配置记录规则（Row-level Security）→ 权限模型见 [04-系统架构设计 5.2](../../04-系统架构设计.md)
- 权限组设计：遵循最小权限原则，按角色分组（普通用户/经理/总监/管理员）→ 权限组清单见 [04-系统架构设计 5.2](../../04-系统架构设计.md)
- 审计日志：关键业务操作（创建/修改/删除订单、审批、付款）自动记录操作人、时间、变更内容
- 敏感数据：密码类字段使用加密存储，API Key 不硬编码在代码中（使用环境变量或 `ir.config_parameter`）
- 安全四层防护：网络层 → 应用层 → 数据层 → 集成层 → 详见 [04-系统架构设计 5.1](../../04-系统架构设计.md)

**违反后果**：缺少权限配置的模块不允许安装到非开发环境。安全评审发现的问题按 P0/P1 级别处理，阻塞发布。

---

## 原则之间的关系

```
P1 质量可控
  ├── 依赖 P5 可验证（质量需要通过测试证明）
  └── 依赖 P3 结构化表达（质量标准需要模型化）

P2 全面透明
  ├── 依赖 P3 结构化表达（透明需要结构化语言）
  ├── 依赖 P4 全链路可追溯（透明需要追溯链）
  └── 依赖 P8 知识沉淀（透明需要知识可查）

P9 AI 可信但必须被理解
  ├── 是 P2 全面透明 在 AI 协作场景的特化
  └── 依赖 P5 可验证（AI 输出需要测试验证）
```

## 原则冲突解决

- **编号优先**：当两条原则冲突时，编号小的优先。例如 P1 质量可控 > P7 渐进交付（不能为了赶进度牺牲质量）。
- **记录例外**：如因特殊原因需违反某原则，必须在 Chatlog 中记录理由、影响范围和补救计划。
- **常见冲突**：P7（快速交付）vs P3（结构化表达）→ 允许先用 Mermaid 草图交付，Phase 3+ 再补正式模型。

---

## 与其他文档的关系

- **上游**：无（本文档是最高层级）
- **下游**：所有其他方法论文档和项目文档都必须遵循这 10 条原则
- **执行参考**：具体执行方式分散在各域文档中，本文档通过引用链接指向

## 待补充（进入开发后）

- [ ] 实际案例：每条原则在项目中的真实应用场景（Phase 1 后补充）
- [ ] 违反案例：真实的违反情况和处理结果（开发过程中记录）

---

## 变更记录

| 版本 | 日期 | 修改内容 |
|------|------|---------|
| v0.1.0 | 2026-02-15 | 纲要创建，10条原则定义确立 |
| v0.2.0 | 2026-02-15 | 填充全部原则的"为什么/怎么做/违反后果"，补充冲突解决机制 |
