# 05 - 质量框架

> 状态: **已确认** | 版本: v0.3.0 | 创建: 2026-02-15 | 更新: 2026-02-17

## 定位

定义项目"怎么保证质量"。核心原则 P1（质量可控）的执行框架。贯穿所有阶段，约束所有工件。

## 五层质量防线

```
L0 建模验证     → 模型是否完整、是否与需求一致
    ↓
L1 AI 规则     → Cursor Rules 约束 AI 输出质量
    ↓
L2 人工审查     → 逻辑验证 + 业务验证 + 安全审查
    ↓
L3 自动化测试   → 单元测试 + 集成测试（TDD/BDD 驱动）
    ↓
L4 UAT 验收    → 业务方在真实场景中确认
    ↓
L5 生产监控    → 上线后持续健康检查与异常检测
```

| 层级 | 执行时机 | 执行方式 | 详见 |
|------|---------|---------|------|
| L0 | 设计阶段 | 人工检查模型完整性 | [03-建模体系](../03-建模体系/README.md) |
| L1 | 每次 AI 生成代码 | Cursor Rules 自动约束 | [07-AI协作协议](../07-AI协作协议/README.md) |
| L2 | 每次代码提交 | 按审查清单人工检查 | [07-AI协作协议 2.2](../07-AI协作协议/README.md) |
| L3 | 每次提交 + CI | Pre-commit + GitHub Actions | [03-开发平台规划 6.1](../../03-开发平台规划.md) |
| L4 | Sprint 结束 / 里程碑 | 业务方演示验收 | 本文档下方 |
| L5 | 上线后持续 | 健康检查 + 日志监控 + 备份验证 | [部署迁移方法](../../01-方法/交付方法/部署迁移方法.md) |

> **L5 层说明**（v0.3.0 新增，基于 Phase 3 试跑经验）：L5 是上线后的持续质量保障层，包括：
> - 服务健康检查（HTTP 200、`pg_isready`、容器状态）
> - 错误日志监控（`docker logs` 无 ERROR/CRITICAL）
> - 备份验证（每日备份存在 + 每月恢复演练）
> - 观察期指标跟踪（可用率、缺陷数、响应时间）

---

## 质量门禁

每个阶段转换都有准入/准出条件。门禁不通过时，阻塞阶段转换（P1 质量可控）。

### Phase 0 → Phase 1 门禁

> Phase 0 目标：开发平台就绪。对齐 [05-项目路线图 M0 里程碑](../../05-项目路线图.md)。

| # | 检查项 | 验证方式 | 通过标准 |
|---|--------|---------|---------|
| 1 | Docker 开发环境 | 执行 `docker-compose up -d` | 所有容器正常运行，无报错 |
| 2 | Odoo 可访问 | 浏览器访问 `http://localhost:8069` | 能看到 Odoo 登录页面 |
| 3 | 数据库连接 | Odoo 登录后操作 | 能创建/查看记录 |
| 4 | Cursor Rules | 检查 `.cursor/rules/` 目录 | 6 个规则文件存在且内容完整 |
| 5 | Git + CI | push 到 GitHub 触发 Actions | 流水线运行通过（至少 lint 步骤） |
| 6 | 测试模块 | 安装测试模块到 Odoo | 模块安装成功，测试用例通过 |
| 7 | 项目文档 | 检查 docs/ 目录 | README、Chatlog 规范在用 |

### Phase 1 → Phase 2 门禁

> Phase 1 目标：需求分析与设计完成（纯文档，无代码）。

| # | 检查项 | 通过标准 |
|---|--------|---------|
| 1 | Gap-Fit 分析 | 至少 1 个核心业务域完成 Gap-Fit 分析，每项需求有处理策略 |
| 2 | 需求建模 | 核心业务域的需求模型已完成（BPMN 流程 + 数据模型） |
| 3 | RBAC 设计 | 权限角色矩阵已设计（含 Odoo 安全组继承关系） |
| 4 | Sprint 规划 | 基于 Gap-Fit 结果的 Sprint 0~N 规划已确定 |
| 5 | 文档完整 | BRD/Gap-Fit 报告/架构设计文档存在且已确认 |

> **v0.3.0 修正**：原门禁包含 erp_base 模块安装等代码要求，与 Phase 1"纯分析不写代码"原则矛盾。已修正为纯文档检查。

### Phase 2 → Phase 3 门禁

> Phase 2 目标：核心业务模块开发完成。

| # | 检查项 | 通过标准 |
|---|--------|---------|
| 1 | 标准模块 | 采购/销售/库存/财务模块安装成功 + 配置验证（功能启用后可用） |
| 2 | 自定义模块 | 所有 `custom_addons/` 模块安装成功且单元测试通过 |
| 3 | 端到端流程 | 至少 1 条完整业务流程可走通（如：采购申请→订单→入库→付款） |
| 4 | 测试覆盖 | **自定义模块**测试覆盖率 ≥ 80%（标准模块不计入） |
| 5 | 性能基线 | 核心页面响应时间 < 2s（100 条数据） |
| 6 | 安全评审 | 权限配置完整 + Odoo 安全配置检查清单全部通过（见下方） |

> **试跑经验**：区分"标准模块配置验证"和"自定义模块测试覆盖"非常重要。标准模块由 Odoo 社区维护，项目层验证其配置正确性即可；自定义模块须有完整的单元/E2E 测试。

### Phase 3 → 上线门禁

> 具体条件在 Phase 2 完成后细化。

| # | 检查项 | 通过标准 |
|---|--------|---------|
| 1 | UAT 验收 | 业务方确认核心流程无问题 |
| 2 | 数据迁移 | 迁移脚本执行成功，数据校验通过 |
| 3 | 生产环境 | 部署完成，健康检查通过 |
| 4 | 回滚方案 | 回滚脚本和流程已验证 |

### Sprint 完成门禁（Phase 2 内部）

每个 Sprint 结束时，以下条件全部满足才算"完成"：

| # | 检查项 | 通过标准 |
|---|--------|---------|
| 1 | 代码审查 | 本 Sprint 所有代码已通过审查（快速或深度） |
| 2 | 测试通过 | 所有测试用例通过，新增代码覆盖率 ≥ 80% |
| 3 | 功能演示 | Sprint Review 中成功演示了计划的功能 |
| 4 | 文档更新 | 涉及的模块文档/流程图已更新 |
| 5 | 无 P0/P1 缺陷 | 本 Sprint 引入的 P0/P1 缺陷已修复 |
| 6 | Chatlog 记录 | 本 Sprint 的关键决策已记录 |

---

## 缺陷分级

| 级别 | 定义 | 处理要求 | Odoo ERP 场景示例 |
|------|------|---------|------------------|
| **P0** | 系统崩溃 / 数据丢失 / 安全漏洞 | **立即修复**，阻塞一切发布 | 数据库迁移失败导致数据丢失；权限配置缺失导致普通用户可删除财务凭证 |
| **P1** | 核心流程阻断 | **24h 内修复**，阻塞发布 | 销售订单无法确认；采购入库后库存数量不更新；审批流程卡死 |
| **P2** | 功能异常但有绕过方式 | **Sprint 内修复** | 报表导出 Excel 格式错乱（可导出 PDF 替代）；搜索筛选器缺少某个条件 |
| **P3** | 体验问题 / 优化建议 | **放入 Backlog** | 列表页排序不理想；字段标签文案不准确；页面加载稍慢但可接受 |

**缺陷管理流程**：发现 → 分级 → 记录（GitHub Issues）→ 分配到 Sprint → 修复 → 验证 → 关闭

---

## Odoo 安全配置检查清单

> v0.3.0 新增。基于 Phase 3 试跑安全审计提取的必检项。适用于 Phase 2→3 门禁和 Phase 3 安全审计。

| # | 检查项 | 配置位置 | 生产要求 | 风险等级 |
|---|--------|---------|---------|---------|
| 1 | `list_db = False` | `odoo.conf` | 禁止数据库列表暴露 | P0 |
| 2 | `admin_passwd` 已修改 | `odoo.conf` | 非默认值，≥ 16 位强密码 | P0 |
| 3 | `proxy_mode = True` | `odoo.conf` | Nginx 反向代理时必须启用 | P1 |
| 4 | HTTPS 强制启用 | Nginx | HTTP → HTTPS 301 跳转 | P1 |
| 5 | `--dev=` 参数未使用 | 启动命令 | 生产环境不可带 `--dev` 参数 | P1 |
| 6 | Session 超时 | `odoo.conf` | 合理超时（≤ 7200s） | P2 |
| 7 | `client_max_body_size` | Nginx | 限制上传大小（推荐 25M） | P2 |
| 8 | 文件上传类型限制 | Odoo 配置 | 禁止可执行文件上传 | P2 |
| 9 | RBAC 权限验证 | Odoo 后台 | 按角色登录验证，只能访问授权功能 | P1 |
| 10 | 记录规则（`ir.rule`） | Odoo 后台 | 跨公司/跨部门数据隔离生效 | P1 |

> **试跑发现**：开发环境 `odoo.conf` 通常包含 `list_db = True`、弱 `admin_passwd` 等配置。Phase 3 安全审计发现 3 个 P2 级别的 dev/prod 配置差异。建议使用独立的 `odoo.prod.conf` 和 `docker-compose.prod.yml` 分离环境配置。

---

## 质量度量指标

| 指标 | 目标值 | 度量方式 | 状态 |
|------|--------|---------|------|
| 测试覆盖率 | ≥ 80% | `pytest --cov` | 已确认 |
| 核心逻辑覆盖率 | 100% | 人工标记核心方法 + 覆盖率检查 | 已确认 |
| 建模覆盖率 | 核心模块 100% | 模块交付检查清单 | 已确认 |
| 缺陷密度 | < 5 个 P2+/模块 | UAT 阶段统计 | 已确认 |
| Sprint 完成率 | ≥ 85% | 完成故事点 / 计划故事点 | 已确认 |
| AI 代码采纳率 | ≥ 70% | 采纳行数 / AI 生成行数 | 已确认 |
| P0/P1 修复时间 | P0: 立即, P1: < 24h | 从发现到修复的时间 | 已确认 |

---

## 质量改进

- 每个 Sprint 结束后的回顾会议中，包含质量专项回顾
- 回顾内容：本 Sprint 缺陷数量/分布、测试覆盖率变化、审查发现的共性问题
- 发现的共性问题转化为 Cursor Rules 或代码审查清单更新

---

## 与其他文档的关系

- **上游**：[01-核心原则](../01-核心原则/README.md)（P1 质量可控、P5 可验证）
- **执行方式**：
  - L0 建模验证 → [03-建模体系](../03-建模体系/README.md)
  - L1 AI 规则 → [07-AI协作协议](../07-AI协作协议/README.md)
  - L2 人工审查 → [07-AI协作协议 2.2](../07-AI协作协议/README.md)
  - L3 自动化测试 → [03-开发平台规划 6.1](../../03-开发平台规划.md)
  - L4 UAT → Sprint Review
- **阶段定义**：[02-过程方法论/sdlc.md](../02-过程方法论/sdlc.md)（门禁对齐阶段划分）
- **里程碑对齐**：[05-项目路线图](../../05-项目路线图.md)

---

## 变更记录

| 版本 | 日期 | 修改内容 |
|------|------|---------|
| v0.1.0 | 2026-02-15 | 纲要创建 |
| v0.2.0 | 2026-02-15 | 填充 Phase 0/1/2/上线门禁、Sprint 门禁、缺陷分级示例、度量指标确认 |
| v0.3.0 | 2026-02-17 | 基于 Phase 1~3 试跑反馈：新增 L5 生产监控层、修正 Phase 1→2 门禁（移除代码要求）、精化 Phase 2→3 门禁（区分标准/自定义模块）、新增 Odoo 安全配置检查清单 |
